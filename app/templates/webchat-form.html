{% extends 'base-' + display_region + '.html' %}

{% if display_region == 'cy' %}
    {% set web_form_url = '#' %}
{% elif display_region == 'ni' %}
    {% set web_form_url = '#' %}
{% else %}
    {% set web_form_url = '#' %}
{% endif %}

{% from 'components/input/_macro.njk' import onsInput %}
{% from 'components/button/_macro.njk' import onsButton %}
{% from 'components/select/_macro.njk' import onsSelect %}
{% from 'components/radios/_macro.njk' import onsRadios %}
{% from 'components/textarea/_macro.njk' import onsTextarea %}
{% from 'components/panel/_macro.njk' import onsPanel %}

{% from 'macros/time/_macro.njk' import rhTime %}

{% set messages_dict=dict(get_flashed_messages()|groupby('level')) %}
{% set field_messages_dict=dict(messages_dict['ERROR']|groupby('field')) %}

{% set form =  {
    'method': 'POST',
    'attributes': {
        'action': url('WebChat:post', display_region=display_region)
    }
} %}

{% block main %}

    {% if webchat_status == 'closed' %}

        <h1 class="u-fs-xxl u-mt-l">{{_('Web chat unavailable')}}</h1>

        <p>{{ _('Our contact centre is now closed.') }}</p>

        {% autoescape false %}
            <p>{{ _('You can still contact us through our %(open)sweb form%(close)s.', open='<a href="%s">' %  web_form_url, close='</a>')|safe }}</p>
        {% endautoescape %}

        <h2 class="u-fs-l u-mt-l">{{_('Web chat opening times')}}</h2>
        <p>
            {{_('Monday to Friday &ndash; %(open_time)s to %(close_time)s', open_time=rhTime({'time': weekday_open }), close_time=rhTime({'time': weekday_close }) )|safe }}<br/>
            {{_('Saturday &ndash; %(open_time)s to %(close_time)s', open_time=rhTime({'time': saturday_open }), close_time=rhTime({'time': saturday_close }) )|safe }}<br/>
            {{_('Census Saturday, 20 March &ndash; %(open_time)s to %(close_time)s', open_time=rhTime({'time': census_saturday_open }), close_time=rhTime({'time': census_saturday_close }) )|safe }}<br>
            {{_('Census Day, 21 March &ndash; %(open_time)s to %(close_time)s', open_time=rhTime({'time': census_sunday_open }), close_time=rhTime({'time': census_sunday_close }) )|safe }}
        </p>

    {% else %}

        <noscript>
            <h1 class="u-fs-xxl u-mt-l">{{_('Javascript disabled')}}</h1>

            <p>{{_('Javascript on your browser is disabled. To start a Webchat session javascript needs to be enabled on your browser.')}}</p>

            <p><a href="{{ help_url }}">{{_('Get Help')}}</a></p>
        </noscript>

        {% if messages_dict %}
            {% include 'partials/messages.html' with context %}
        {% endif %}

        {% set country_options =
            [
                {
                    'id': 'england',
                    'label': {
                        'text': _('England')
                    },
                    'value': 'england'
                },
                {
                    'id': 'wales',
                    'label': {
                        'text': _('Wales')
                    },
                    'value': 'wales'
                },
                {
                    'id': 'northern_ireland',
                    'label': {
                        'text': _('Northern Ireland')
                    },
                    'value': 'northern_ireland'
                }
            ]
        %}

        {% set query_options =
            [
                {
                    'id': 'missing_information',
                    'label': {
                        'text': _('I donâ€™t have everything I need to complete my census')
                    },
                    'value': 'missing_information'
                },
                {
                    'id': 'technical',
                    'label': {
                        'text': _('I am having technical difficulties')
                    },
                    'value': 'technical'
                },
                {
                    'id': 'form',
                    'label': {
                        'text': _('I need help with my census form')
                    },
                    'value': 'form'
                },
                {
                    'id': 'complaint',
                    'label': {
                        'text': _('I have a complaint')
                    },
                    'value': 'complaint'
                },
                {
                    'id': 'address',
                    'label': {
                        'text': _('I need help with my address')
                    },
                    'value': 'address'
                },
                {
                    'id': 'something_else',
                    'label': {
                        'text': _('Something else')
                    },
                    'value': 'something_else'
                }
            ]
        %}

        <div id="web-chat-form-display" class="web-chat-form__body" style="display:none;">
            <h1 class="u-fs-xxl u-mt-l">{{_('Enter web chat details')}}</h1>

            {{
                onsPanel({
                    'body': _('Data stored during web chat sessions will not be shared with third parties')
                })
            }}

            {% if 'screen_name' in field_messages_dict %}
                {{
                    onsInput({
                        'id': 'screen_name',
                        'name': 'screen_name',
                        'label': {
                            'text': _('Enter your name')
                        },
                        'value': form_value_screen_name,
                        'classes': 'input--w-20@m js-name',
                        'error': {
                            'text': _('Enter your name')
                        }
                    })
                }}
            {% else %}
                {{
                    onsInput({
                        'id': 'screen_name',
                        'name': 'screen_name',
                        'label': {
                            'text': _('Enter your name')
                        },
                        'value': form_value_screen_name,
                        'classes': 'input--w-20@m js-name'
                    })
                }}
            {% endif %}

            {% if 'country' in field_messages_dict %}
                {{
                    onsRadios({
                        'legend': _('Select your country'),
                        'name': 'country',
                        'dontVisuallyHideLegend': true,
                        'value': form_value_country,
                        'radios': country_options,
                        'error': {
                            'text': _('Select an option')
                        }
                    })
                }}
            {% else %}
                {{
                    onsRadios({
                        'legend': _('Select your country'),
                        'name': 'country',
                        'dontVisuallyHideLegend': true,
                        'value': form_value_country,
                        'radios': country_options
                    })
                }}
            {% endif %}

            {% if 'query' in field_messages_dict %}
                {{
                    onsRadios({
                        'legend': _('What do you need help with?'),
                        'name': 'query',
                        'dontVisuallyHideLegend': true,
                        'value': form_value_query,
                        'radios': query_options,
                        'error': {
                            'text': _('Select an option')
                        }
                    })
                }}
            {% else %}
                {{
                    onsRadios({
                        'legend': _('What do you need help with?'),
                        'name': 'query',
                        'dontVisuallyHideLegend': true,
                        'value': form_value_query,
                        'radios': query_options
                    })
                }}
            {% endif %}

            {{
                onsButton({
                    'text': _('Start web chat'),
                    'classes': 'btn-group__btn u-mb-m u-mt-m'
                })

            }}

        </div>

    {% endif %}

{% endblock %}

{% block scripts %}

<script type="text/javascript">
    document.getElementById('web-chat-form-display').style.display='block';
</script>

{% endblock %}
